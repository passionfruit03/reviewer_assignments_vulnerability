import os
from datetime import datetime

import shared
from gpt_helpers import Prompt
from specter import Specter
from dataset import AttackDataset
from attacker import Attacker

shared.model = Specter("v1", device="cpu")
shared.prompts = {
    "include_themes": Prompt("prompts/include_themes", "fully_automatic_prompt.txt"),
    "insert_keywords": Prompt("prompts/insert_keywords", "fully_automatic_prompt.txt")
}

shared.gpt_model = "gpt-4-0125-preview"
shared.dataset_dir = "/home/jhihyih/data/peer-review/nips23"
shared.surrogate_dataset_dir = "/home/jhihyih/data/peer-review/nips22"
shared.reviewers_file = "reviewer_ids.txt"
shared.use_stopping_criteria = True
shared.similarity_mode = "avg"
shared.attack_mode = "auto"
output_dir = "out"

now = datetime.now()
if not os.path.isdir(os.path.join(output_dir, now.strftime("%Y-%m-%d"))):
    os.mkdir(os.path.join(output_dir, now.strftime("%Y-%m-%d")))
shared.run_folder = os.path.join(output_dir, now.strftime("%Y-%m-%d"), now.strftime("%H-%M-%S"))

attacker = Attacker(num_papers_to_keep=1, N=1, M=1, k=1)
dataset = AttackDataset(
    f"{shared.dataset_dir}/evaluation_samples/attacks_rank101.jsonl",
    start=0,
    end=1
)

attacker.attack_dataset(dataset)